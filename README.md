# Asm. Транслятор и модель

- Маликов Александр Максимович
- `asm | stack | harv | hw | instr | struct | trap -> stream | mem | pstr | prob1 | cache`
- Базовый вариант. Без усложнений.


## Язык программирования

``` ebnf
line            ::=   section | label comment? "\n"
                      | declaration comment? "\n"
                      | instr comment? "\n"
                      | comment "\n"

program         ::=     line*


section         ::=     "." section_name
section_name    ::=     "data" | "code"

declaration     ::=     variable_name type value
variable_name   ::=     <any of "a-z A-Z _"> { <any of "a-z A-Z 0-9 _"> }
type            ::=     NUMBER | STRING
value           ::=     number | string
number          ::=     { <any of "0-9"> }
string          ::=     "\"" { <any symbols except "\""> } "\""
                      | "\'" { <any symbols except "\'"> } "\'"

label           ::=     label_name ":"
label_name      ::=     <any of "a-z A-Z _"> { <any of "a-z A-Z 0-9 _"> }

instr           ::=     opcode0
                      | opcode1 operand | label_name 
              
opcode0         ::=     "POP" 
                      | "DUP" 
                      | "INC" 
                      | "DEC" 
                      | "SWAP" 
                      | "ADD" 
                      | "SUB" 
                      | "MUL" 
                      | "DIV" 
                      | "COMPARE" 
                      | "LOAD" 
                      | "SAVE"
                      | "NOP"
                      | "HLT"
                      
opcode1         ::=     "PUSH" 
                      | "JMP" 
                      | "JEQ" 
                      | "JNE" 
                      | "PRINT" 
                      | "PRINT_VAL" 
                      | "PRINT_BY_INDEX"  

operand             ::=     value | variable_name

comment         ::=     ";" <any symbols except "\n">
```

Примечания:
- Код выполняется последовательно
- Область видимости - глобальная
- Первая указанная команда в сегменте инструкций считается началом программы
- Все переменные должны быть объявлены до использования в секции данных
- В программе не может быть меток, переменных и команд с одинаковыми именами
- Метки могут быть объявлены в любом месте программы, на отдельной строке
- Метка `interrupt` определяет исполняемый блок прерывания для чтения

Система команд:

- `PUSH value`          -- положить value на вершину стека
- `PUSH_VAL name`           -- положить адрес переменной на вершину стека
- `POP`                           -- сместить указатель вершины стека на одну ячейку влево
- `DUP`                     -- дублирование значения на вершине стека
- `INC`                 -- увеличить значение на вершине стека на 1
- `DEC`    -- уменьшить значение на вершине стека на 1
- `JMP`                          -- безусловный переход
- `JEQ`        -- условный переход, где сравнение `a == b` истинно 
- `JNE`  -- условный переход, где сравнение `a != b` истинно
- `SWAP`             -- поменять местами два верхних значения на вершине стека
- `ADD`             -- сложить два верхних значения на вершине стека
- `SUB`             -- вычесть из второго верхнего значения на стеке первое
- `MUL`             -- умножить два верхних значения на вершине стека
- `DIV`             -- разделить второе значение на вершине стека на первое
- `COMPARE`           -- сравнить два значения на вершине стека
- `LOAD addr`            -- по переданному адресу, загрузить на вершину стека значение из памяти
- `SAVE`            -- записать вершину стека в память по адресу (значению) второго значения в стеке
- `PRINT`             -- записать вершину стека как литерал на устройство вывода 
- `PRINT_VAL`            -- записать вершину стека в устройство вывода
- `PRINT_BY_INDEX`             -- записать значение из памяти в устройство вывода, по адресу (значению) вершины стека
- `NOP`             -- ничего не выполнять
- `HLT`     -- завершить выполнение программы
## Организация памяти

```
    data memory
+------------------+
| 00 :     in      |
| 01 :     out     |
| 02 :     ...     |
+------------------+

 instruction memory 
+------------------+
| 00 :     ...     |
|          ...     |
| n  :    struct   |
+------------------+

```
Пример инструкции в struct:
`{"index": 12, "opcode": "JMP", "arg": 1}`

Исходный код транслируется в файл, содержащий две секции:
 1) Данные
 2) Инструкции
- У программиста нет доступа к памяти инструкций
- Порты ввода-вывода отображаются в память. Для доступа к ним используются обращения к определенным заранее ячейкам в памяти данных
- Прямая адресация
- Все строки - массив символов, название переменной при трансляции заменяется на адрес, указывающий на число - количество символов в строке, где после хранится указанное число символов
## Транслятор

Интерфейс командной строки: `translator.py <input_file> <target_file>`

Реализовано в модуле: [translator](translator.py)

Этапы трансляции (функция `main`):

1. Удаление комментариев
2. Разделение секции данных и секции инструкций
3. Определение `labels` и их адресов
4. Конвертация инструкций в `struct` и подстановка адресов переменных
5. Объединение данных и команд

## Модель процессора
```
python machine.py <code_filepath> <stack_size> <input_filepath> <ticks_limit> <log_filepath>
```
### Data Path

Реализован в классе `DataPath`.

//тут должно быть изображение схемы//

//тут описывающий логику текст//

### Control Unit

Реализован в классе `ControlUnit`.

//тут должно быть изображение схемы//

//тут описывающий логику текст//
## Тестирование
Тестирование происходит при помощи Golden-тестов
Тесты реализованы в: [golden_test.py](golden_test.py). 

Конфигурации:
- [golden/cat.yml](golden/cat.yml)
- [golden/hello_world.yml](golden/hello_world.yml)
- [golden/hello_user.yml](golden/hello_user.yml)
- [golden/prob1.yml](golden/prob1.yml)

Запустить тесты: `poetry run pytest . -v`

Обновить конфигурацию golden tests:  `poetry run pytest . -v --update-goldens`

CI при помощи Github Action: [.github/workflows/asm.yml](.github/workflows/asm.yml)

```text
| ФИО                          | алг        | LoC  | code байт | code инстр. | инстр.    | такт.    | вариант |
| Маликов Александр Максимович | hello      | 18   | -         | 12          | 94        | 318      | -       |
| Маликов Александр Максимович | cat        | 19   | -         | 14          | 143       | 427      | -       |
| Маликов Александр Максимович | hello_user | 110  | -         | 77          | 450       | 1461     | -       |
| Маликов Александр Максимович | prob1      | 97   | -         | 82          | 6617      | 24632    | -       |
```